$(document).ready(function(){$("#canvas-container").hide(),$("#loading").hide(),$("#notfound").hide(),nd=new Date,nd.setDate(nd.getDate()-1);var e={weekday:"long",year:"numeric",month:"long",day:"numeric"};todaterange=new Date(nd),todaterange=todaterange.toLocaleDateString("en-US",e),nd.setDate(nd.getDate()-41),fromdaterange=new Date(nd),fromdaterange=fromdaterange.toLocaleDateString("en-US",e),$("#fromdaterange").html(fromdaterange),$("#todaterange").html(todaterange)});const kFormatter=e=>Math.abs(e)>999?Math.sign(e)*(Math.abs(e)/1e3).toFixed(1)+"k":Math.sign(e)*Math.abs(e),dynamicColors=()=>{return"rgba("+Math.floor(200*Math.random())+","+Math.floor(200*Math.random())+","+Math.floor(200*Math.random())+", 0.7)"},poolColors=e=>{var a=[];for(i=0;i<e;i++)a.push(dynamicColors());return a},pieChartTable=(e,a)=>{$.each(e,function(e,a){$typ=$("#type"+e),$typ.html(a)}),$.each(a,function(e,t){$val=$("#percent"+e);per=(100*t/(e=>e.reduce((e,a)=>e+a,0))(a)).toFixed(1)+"%",$val.html(per)})},trendChartTable=(e,a,t)=>{$.each(e,function(e,a){$lab=$("#lab"+e),$lab.html(a)}),$.each(a,function(e,a){$val=$("#val"+e),$val.html(a.toLocaleString())}),$.each(t,function(e,a){$lval=$("#lval"+e),$lval.html(a.toLocaleString())})},jsonPieGenerate=e=>{console.log(e);var a=e.rows[0];if(null!=a){$("#chart").remove(),$("#chart-canvas").append('<canvas id="chart"></canvas>'),val=a.data;var t=[{data:val,backgroundColor:poolColors(2)}],r={plugins:{beforeInit:(e,a)=>{Chart.Legend.afterFit=function(){this.height=this.height+50}},datalabels:{formatter:(e,a)=>{let t=0;return a.chart.data.datasets[0].data.map(e=>{t+=e}),(100*e/t).toFixed(1)+"%"},backgroundColor:function(e){return e.dataset.backgroundColor},borderRadius:4,color:"white",font:{weight:"bold"}}},tooltips:{enabled:!1},legend:{position:"bottom",minSize:{height:500}},layout:{padding:{top:25}}},n=document.getElementById("chart").getContext("2d"),o=new Chart(n,{type:"pie",data:{datasets:t,labels:["Mobile","Desktop"]},options:r});pieChartTable(o.data.labels,val),$("#chart-pltfrms").show(),$("#chrtp").hide()}else $("#chart-pltfrms").hide(),$("#chrtp").show()},jsonTrendGenerate=e=>{console.log(e);var a=e.rows[0];if(null!=a){$("#trends").remove(),$("#trends-canvas").append('<canvas id="trends"></canvas>'),arr=a.data,val=arr.slice(0,6),lval=arr.slice(6,12);var t={plugins:{datalabels:{formatter:(e,a)=>kFormatter(e),backgroundColor:function(e){return e.dataset.backgroundColor},borderRadius:4,color:"white",font:{weight:"bold"},align:function(e){var a,t,r,n=e.dataIndex,o=e.dataset.data[n],l=e.chart.data.datasets,s=o,c=o;for(a=0,t=l.length;a<t;++a)if(a!==e.datasetIndex){if(r=l[a].data[n],s=Math.min(s,r),c=Math.max(c,r),maxMed=c/2,o<maxMed)return"end";if(o>s&&o<c)return"center"}return o<=s?"start":"end"}}},scales:{yAxes:[{afterBuildTicks:function(e){e.ticks=function(e){var a=0,t=0,r=[];for(r=e.ticks,x=0;x<r.length;x++)a=t-r[x],t=r[x];return r.length>2&&r[0]-r[1]!=a&&(r[0]=r[1]+a),r}(e)},beforeUpdate:function(e){},ticks:{beginAtZero:!0,beginAtZero:!0,padding:6,callback:function(e,a,t){return kFormatter(e)}},scaleLabel:{display:!0,labelString:"Number of visits"}}]},tooltips:{enabled:!1},legend:{position:"bottom",labels:{usePointStyle:!0}},layout:{padding:{top:25}}},r=document.getElementById("trends").getContext("2d"),n=new Chart(r,{type:"line",data:{datasets:[{label:"Current year",data:val,backgroundColor:dynamicColors()},{label:"Previous year",data:lval,backgroundColor:dynamicColors()}],labels:["Week 1","Week 2","Week 3","Week 4","Week 5","Week 6"]},options:t});trendChartTable(n.data.labels,val,lval),$("#chart-trnds").show(),$("#chrtt").hide()}else $("#chart-trnds").hide(),$("#chrtt").show()},jsonUv=e=>{console.log(e);var a=e.rows[0],t=$("#uv"),r=$("#rap");if(null!=a)return uv=a.data[0]/7/6,t.html(parseInt(uv).toLocaleString()),rap=a.data[1]/7,r.html(parseInt(rap).toLocaleString()),itemid=a.itemId,itemid;t.html("0"),r.html("0")},jsonFile=e=>{console.log(e)},getPageTitle=e=>Object.keys(e).map((a,t)=>{var r=e[a].value;if(-1!==(r=-1!==r.indexOf("https://")?r:"https://"+r).indexOf("canada.ca")){let e=new Request(r,{method:"GET"});return fetch(e).then(e=>e.text()).then(e=>$(e).find("h1:first").text()).catch(console.error.bind(console))}}),jsonPrevious=e=>{console.log(e);var a=e.rows[0],t=$("#pp");null!=a?(array=e.rows,t.html(""),t.append($("<ul>")),t=$("#pp ul"),Promise.all(getPageTitle(array)).then(e=>{$.each(array,function(a,r){url=r.value,term=null==e[a]?url:e[a],val=r.data[0],f="blank page url"==url?"Direct traffic / Bookmark":"<a href='"+url+"'>"+term+"</a>",t.append($("<li>").append(f))})}).catch(console.error.bind(console))):t.html("No data")},jsonForward=e=>{console.log(e);var a=e.rows[0],t=$("#np");null!=a?(array=e.rows,t.html(""),t.append($("<ul>")),t=$("#np ul"),Promise.all(getPageTitle(array)).then(e=>{$.each(array,function(a,r){url="https://"+r.value,term=null==e[a]?url:e[a],val=r.data[0],t.append($("<li>").append("<a href='"+url+"'>"+term+"</a>"))})}).catch(console.error.bind(console))):t.html("No data")},jsonSnum=e=>{console.log(e);var a=e.rows[0],t=$("#snum");if(null!=a)return snum=a.data/7/6,itemid=a.itemId,t.html(parseInt(snum).toLocaleString()),itemid;var r=new Array(4);t.html("0"),$search=$("#search0"),$search.html("No data"),$.each(r,function(e,a){0!=e&&($search=$("#search"+e),$search.html(""))})},jsonSearches=e=>{console.log(e),array=e.rows,$.each(array,function(e,a){$search=$("#search"+e),$search.html(""),search=a.value,searchurl="https://www.canada.ca/en/revenue-agency/search.html?cdn=canada&st=s&num=10&langs=en&st1rt=1&s5bm3ts21rch=x&q="+search+"&_charset_=UTF-8&wb-srch-sub=",searchv=a.data[0],$search.append("<a href='"+searchurl+"'>"+search+"</a>").append(" ("+searchv.toLocaleString()+")")})};var cnt=0;const apiCall=(e,a,t)=>a.map(a=>{url="fle"==a?"php/file.php":"php/process.php",post={url:e,type:a};let r=new Request(url,{method:"POST",body:$.param(post),headers:{Accept:"application/json, text/plain, */*","Content-Type":"application/x-www-form-urlencoded; charset=UTF-8"}});return fetch(r).then(e=>e.json()).then(e=>{switch(cnt++,$("#percent").html((100*cnt/t).toFixed(1)+"%"),a){case"uvrap":return jsonUv(e);case"fle":return jsonFile(e);case"snm":return jsonSnum(e);case"srch":return jsonSearches(e);case"trnd":return jsonTrendGenerate(e);case"pltfrm":return jsonPieGenerate(e);case"prvs":return jsonPrevious(e);case"frwrd":return jsonForward(e)}})});$("#urlform").submit(function(e){e.preventDefault(),$("#canvas-container").hide(),$("#notfound").hide(),$("#loading").show(),$success=0;var a=$("#urlval").val();if("www."==(a="https://"==a.substring(0,8)?a.substring(8,a.length):a).substring(0,4)&&".html"==a.substring(a.length-5,a.length)){a=a.length>255?a.substring(a.length-255,a.length):a,$("#searchBttn").prop("disabled",!0);var t=["snm","uvrap","pltfrm","trnd","fle"],r=["srch","frwrd"],n=["prvs"];let e=t.concat(r).concat(n).length;cnt=0,$("#percent").html((100*cnt/e).toFixed(1)+"%");const o=a=>{if(null!=a)return Promise.all(apiCall(a,r,e));$("#np").html("No data")},l=a=>{if(null!=a)return Promise.all(apiCall(a,n,e));$("#pp").html("No data")};(()=>Promise.all(apiCall(a,t,e)))().then(e=>(o(e[0]),e)).then(e=>l(e[1])).then(()=>{$("#loading").hide(),$("#notfound").hide(),$("#canvas-container").show(),$("#searchBttn").prop("disabled",!1)}).catch(console.error.bind(console)),$success=1}$success||($("#loading").hide(),$("#notfound").show())});