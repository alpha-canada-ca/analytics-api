$(document).ready(function(){$("#canvas-container").hide(),$("#loading").hide(),$("#notfound").hide()});const kFormatter=e=>Math.abs(e)>999?Math.sign(e)*(Math.abs(e)/1e3).toFixed(1)+"k":Math.sign(e)*Math.abs(e),dynamicColors=()=>{return"rgba("+Math.floor(200*Math.random())+","+Math.floor(200*Math.random())+","+Math.floor(200*Math.random())+", 0.7)"},poolColors=e=>{var t=[];for(i=0;i<e;i++)t.push(dynamicColors());return t};function generateTableHead(e,t,a){e.createCaption().innerHTML=a;let r=e.createTHead().insertRow();for(let e of t){let t=document.createElement("th"),a=document.createTextNode(e);t.appendChild(a),r.appendChild(t)}}function generateTable(e,t){for(let a of t){let t=e.insertRow();for(key in a){let e=t.insertCell(),r=document.createTextNode(a[key]);e.appendChild(r)}}}const jsonPieGenerate=e=>{var t=e.rows[0];if(null!=t){$("#chart").remove(),$("#chart-canvas").append("<canvas id='chart'></canvas>"),val=t.data,cnt=val.length;var a=[{data:val,backgroundColor:poolColors(cnt)}],r={plugins:{beforeInit:(e,t)=>{Chart.Legend.afterFit=function(){this.height=this.height+50}},datalabels:{formatter:(e,t)=>{let a=0;return t.chart.data.datasets[0].data.map(e=>{a+=e}),(100*e/a).toFixed(1)+"%"},backgroundColor:function(e){return e.dataset.backgroundColor},borderRadius:4,color:"white",font:{weight:"bold"}}},tooltips:{enabled:!1},legend:{position:"bottom",minSize:{height:500}},layout:{padding:{top:25}}},n=document.getElementById("chart").getContext("2d"),s=new Chart(n,{type:"pie",data:{datasets:a,labels:["Desktop","Mobile Phone","Tablet","Other"]},options:r});sum=val.reduce(function(e,t){return e+t},0);let e=[];$.each(val,function(t,a){val=a,lab=s.data.labels[t],per=(100*val/sum).toFixed(2)+"%",val=a.toLocaleString(),e.push({"Device Type":lab,Visits:val,Percent:per})});let l=document.querySelector("table#tbl-pltfrm"),o=Object.keys(e[0]);l.innerHTML="",generateTableHead(l,o,"Number of visits by devices used"),generateTable(l,e),$("#chart-pltfrms").show(),$("#chrtp").hide()}else $("#chart-pltfrms").hide(),$("#chrtp").show()},RANGE=(e,t)=>Array.from(function*(e,t){for(;e<=t;)yield e++}(e,t)),jsonTrendGenerate=(e,t)=>{var a=e.rows[0];if(null!=a){$("#trends").remove(),$("#trends-canvas").append("<canvas id='trends'></canvas>"),arr=a.data,$cnt=arr.length,val=arr.slice(0,$cnt/2),lval=arr.slice($cnt/2,$cnt),$rng=RANGE(1,$cnt/2);const e=t.replace(/^\w/,e=>e.toUpperCase());var r={plugins:{datalabels:{display:!1}},scales:{yAxes:[{scaleLabel:{display:!0,labelString:"Number of visits"}}],xAxes:[{scaleLabel:{display:!0,labelString:e+" of selected date range"}}]},tooltips:{mode:"index",intersect:!1},hover:{mode:"nearest",intersect:!0},legend:{position:"bottom",labels:{usePointStyle:!0}},layout:{padding:{top:25}}},n=document.getElementById("trends").getContext("2d"),s=new Chart(n,{type:"line",data:{labels:$rng,datasets:[{label:"Current year",data:val,backgroundColor:dynamicColors()},{label:"Previous year",data:lval,backgroundColor:dynamicColors()}]},options:r});let o=[];var l=1;$.each(val,function(t,a){vals=val[t],lvals=lval[t],lab=s.data.labels[t],gran=e+" "+l,l++,diff=((vals-lvals)/lvals*100).toFixed(1)+"%",vals=val[t].toLocaleString(),lvals=lval[t].toLocaleString(),o.push({[e]:gran,"Current Year":vals,"Previous Year":lvals,Difference:diff})});let d=document.querySelector("table#tbl-trnds"),c=Object.keys(o[0]);d.innerHTML="",generateTableHead(d,c,"Visits trend by current year and previous year"),generateTable(d,o),$("#chart-trnds").show(),$("#chrtt").hide()}else $("#chart-trnds").hide(),$("#chrtt").show()},jsonUv=e=>{var t=e.rows[0],a=$("#uv"),r=$("#rap"),n=parseInt($("#numDays").html()),s=parseInt($("#numWeeks").html());if(a.html(""),r.html(""),null!=t)return uv=t.data[0],uvDays=parseInt(uv/n).toLocaleString(),uv=parseInt(uv).toLocaleString(),a.prepend("<span class='h1'>"+uvDays+"</span> <strong>per day</strong></br><span class='small'>"+uv+" total</span>"),rap=t.data[1],rapWeeks=parseInt(rap/s).toLocaleString(),rap=parseInt(rap).toLocaleString(),r.prepend("<span class='h1'>"+rapWeeks+"</span> <strong>per week</strong></br><span class='small'>"+rap+" total</span>"),itemid=t.itemId,itemid;a.html("0"),r.html("0")},jsonFile=e=>{},getPageTitle=e=>Object.keys(e).map((t,a)=>{var r=e[t].value;if(-1!==(r=-1!==r.indexOf("https://")?r:"https://"+r).indexOf("canada.ca")){let e=new Request(r,{method:"GET"});return fetch(e).then(e=>e.text()).then(e=>$(e).find("h1:first").text()).catch(console.error.bind(console))}}),getPageH1=e=>{var t=e[0].html;return t=(t=t.substr(t.indexOf("<h1"),t.length)).substr(0,t.indexOf("</h1>"))},getPage=e=>{if(-1!==(e=-1!==e.indexOf("https://")?e:"https://"+e).indexOf("canada.ca")){let t=new Request(e,{method:"GET"});return fetch(t).then(e=>e.text()).then(e=>{return{html:e}}).catch(console.error.bind(console))}},jsonPrevious=e=>{var t=e.rows[0],a=$("#pp");null!=t?(arrayP=e.rows,a.html(""),a.append($("<ul>")),a=$("#pp ul"),Promise.all(getPageTitle(arrayP)).then(e=>{$.each(arrayP,function(t,r){url=r.value,term=null==e[t]?url:e[t],val=r.data[0],f="blank page url"==url?"Direct traffic / Bookmark":"<a href='"+url+"'>"+term+"</a>",a.append($("<li>").append(f))})}).catch(console.error.bind(console))):a.html("No data")},jsonForward=e=>{var t=e.rows[0],a=$("#np");null!=t?(arrayF=e.rows,a.html(""),a.append($("<ul>")),a=$("#np ul"),Promise.all(getPageTitle(arrayF)).then(e=>{$.each(arrayF,function(t,r){url="https://"+r.value,term=null==e[t]?url:e[t],val=r.data[0],a.append($("<li>").append("<a href='"+url+"'>"+term+"</a>"))})}).catch(console.error.bind(console))):a.html("No data")},jsonSnum=e=>{var t=e.rows[0],a=$("#snum"),r=parseInt($("#numDays").html());if(a.html(""),null!=t)return snum=t.data,snumDays=parseInt(snum/r).toLocaleString(),snum=parseInt(snum).toLocaleString(),a.prepend("<span class='h1'>"+snumDays+"</span> <strong>per day</strong></br><span class='small'>"+snum+" total</span>"),itemid=t.itemId,itemid;var n=new Array(4);a.html("0"),$search=$("#search0"),$search.html("No data"),$.each(n,function(e,t){0!=e&&($search=$("#search"+e),$search.html(""))})},jsonSearches=e=>{arrayS=e.rows,$.each(arrayS,function(e,t){$search=$("#search"+e),$search.html(""),search=t.value,searchurl="https://www.canada.ca/en/revenue-agency/search.html?cdn=canada&st=s&num=10&langs=en&st1rt=1&s5bm3ts21rch=x&q="+search+"&_charset_=UTF-8&wb-srch-sub=",searchv=t.data[0],$search.append("<a href='"+searchurl+"'>"+search+"</a>").append(" ("+searchv.toLocaleString()+")")})},jsonDownload=e=>{var t=e.rows[0];if($dwnld=$("#dwnld"),null!=t){var a=e.rows;$dwnld.html(""),$dwnld.append($("<ul class='colcount-sm-2'>")),$dwnld=$("#dwnld ul");var r=[],n=[];$.each(a,function(e,t){var a=t.value,s=t.data[0];a.includes(".pdf")?(a.includes("-lp")&&(type="Large Print"),a.includes("-fill-")?type="Fillable":type="Flat"):a.includes(".txt")?type="E-Text":type=a.split("/").pop().split(".").pop().toUpperCase();var l=a.split("/").pop();r.push(a),n.push({term:a,clicks:s,type:type,filename:l})}),$url="https://www.canada.ca/en/revenue-agency/services/forms-publications/td1-personal-tax-credits-returns/td1-forms-pay-received-on-january-1-later/td1.html";var s=$url.split("/").pop().split(".").shift(),l=r.findReg("^https://www.canada.ca/.*?"+s+"-(fill-)*([0-9]{1,2})"),o=$("#np");o.html(""),o.append($("<ul class='colcount-sm-2>")),o=$("#np ul"),$.each(n,function(e,t){$.each(l,function(e,a){t.term==a&&o.append($("<li>").append(t.filename+" ("+t.clicks.toLocaleString()+") [<em>"+t.type+"</em>]"))})})}else $dwnld.html("No data")},jsonOutbound=(e,t)=>{var a=e.rows[0];if($outbnd=$("#outbnd"),null!=a){var r=e.rows;$outbnd.html(""),$outbnd.append($("<ul class='colcount-sm-2'>")),$outbnd=$("#outbnd ul"),Promise.all([getPage(t)]).then(e=>{e[0].html;$.each(r,function(e,t){text=t.value,outbnd=t.data[0],$outbnd.append($("<li>").append(text+" ("+outbnd.toLocaleString()+")"))})})}else $outbnd.html("No data")},jsonSearch=(e,t,a)=>{var r=e.rows[0],n=$(t);if(null!=r){var s=e.rows;n.html("");var l=[];$.each(s,function(e,t){term=t.value,pos=t.data[0],imp=t.data[1],clicks=t.data[2],ctr=(100*clicks/imp).toFixed(1)+"%",pos=pos.toFixed(1),imp=imp.toLocaleString(),clicks=clicks.toLocaleString(),"NaN"!=pos&&"(Low Traffic)"!=term&&"Unspecified"!=term&&l.push({Term:term,Position:pos,Impressions:imp,Clicks:clicks,"Click Through Rate (CTR)":ctr})});let r=document.querySelector("table"+t);generateTableHead(r,Object.keys(l[0]),a),generateTable(r,l)}else n.html("No data")},jsonSearchesInstitution=e=>{jsonSearch(e,"#srchI","Contextual searches to page")},jsonSearchesGlobal=e=>{jsonSearch(e,"#srchG","Global searches to page")};function fetchWithTimeout(e,t,a,r){const n=new Promise(e=>{setTimeout(e,a,{timeout:!0})});return Promise.race([fetch(e,t),n]).then(e=>(e.timeout&&r(),e))}var cnt=0;const apiCall=(e,t,a,r,n)=>a.map(a=>{url="fle"==a?"php/file.php":"php/process.php","trnd"==a&&(day=parseInt($("#numDays").html()),day<=31?day="day":day>31&&day<=105?day="week":day>105&&day<=365?day="month":day="year",e.push(day)),post={dates:e,url:t,type:a,oUrl:n};let s=new Request(url,{method:"POST",body:JSON.stringify(post)});return fetch(s).then(e=>e.json()).then(e=>{switch(cnt++,$("#percent").html((100*cnt/r).toFixed(1)+"%"),a){case"uvrap":return jsonUv(e);case"fle":return;case"snm":return jsonSnum(e);case"srch":return jsonSearches(e);case"trnd":return jsonTrendGenerate(e,day);case"pltfrm":return jsonPieGenerate(e);case"prvs":return jsonPrevious(e);case"frwrd":return jsonForward(e);case"srchI":return jsonSearchesInstitution(e);case"srchG":return jsonSearchesGlobal(e)}}).catch(function(e){console.log(a),console.log(e.message),console.log(e.stack)})});$("#urlform").submit(function(e){e.preventDefault(),$("#canvas-container").hide(),$("#notfound").hide(),$("#loading").show(),$success=0;var t=$("#urlval").val();if("www."==(t="https://"==t.substring(0,8)?t.substring(8,t.length):t).substring(0,4)&&".html"==t.substring(t.length-5,t.length)){t=t.length>255?t.substring(t.length-255,t.length):t,vStart=$(".dr-date-start").html(),vEnd=$(".dr-date-end").html();var a=[s=moment(vStart,"MMMM DD, YYYY").format("YYYY-MM-DDTHH:mm:ss.SSS"),l=moment(vEnd,"MMMM DD, YYYY").add(1,"day").format("YYYY-MM-DDTHH:mm:ss.SSS")],r=moment(vStart,"MMMM DD, YYYY").format("dddd MMMM DD, YYYY"),n=moment(vEnd,"MMMM DD, YYYY").format("dddd MMMM DD, YYYY");$("#fromdaterange").html(r),$("#todaterange").html(n);var s=moment(vStart,"MMMM DD, YYYY"),l=moment(vEnd,"MMMM DD, YYYY").add(1,"day");dDay=l.diff(s,"days"),dWeek=l.diff(s,"week",!0),dMonth=l.diff(s,"month",!0),dQuarter=l.diff(s,"quarter",!0),dYear=l.diff(s,"year",!0),$("#numDays").html(dDay),$("#numWeeks").html(dWeek),$("#searchBttn").prop("disabled",!0);var o=["snm","uvrap","pltfrm","trnd","fle"],d=["srch","frwrd","srchI","srchG"],c=["prvs"];let e=o.concat(d).concat(c).length;cnt=0,$("#percent").html((100*cnt/e).toFixed(1)+"%");const i=r=>{if(null!=r)return Promise.all(apiCall(a,r,d,e,t));$("#np").html("No data")},h=r=>{if(null!=r)return Promise.all(apiCall(a,r,c,e,t));$("#pp").html("No data")};(()=>Promise.all(apiCall(a,t,o,e,t)))().then(e=>(i(e[0]),e)).then(e=>h(e[1])).then(()=>{$("#loading").hide(),$("#notfound").hide(),$("#canvas-container").show(),$("#searchBttn").prop("disabled",!1)}).catch(console.error.bind(console)),$success=1}$success||($("#loading").hide(),$("#notfound").show())});