function getQueryParams(){let e={},t=window.location.search;return(t=t.substr(1)).split("&").forEach(function(t){let a=t.split("=");e[a[0]]=decodeURIComponent(a[1])}),e}function getSpecifiedParam(e,t){for(let[a,n]of Object.entries(e))if(a===t)return n}$(document).on("wb-ready.wb",function(){$.i18n().load({en:"./assets/js/i18n/en.json",fr:"./assets/js/i18n/fr.json"}).done(function(){$("html").i18n(),$(".app-name").text($.i18n("app-title")),$("#allspan").removeClass("hidden")});let e=getQueryParams();var t,a,n;t=getSpecifiedParam(e,"url"),a=getSpecifiedParam(e,"start"),n=getSpecifiedParam(e,"end"),a&&n&&(a=moment(a).format("MMMM D, YYYY"),n=moment(n).format("MMMM D, YYYY"),$(".dr-date-start").html(a),$(".dr-date-end").html(n)),t&&($("#urlval").val(t),mainQueue(t,a,n,0))});const kFormatter=e=>Math.abs(e)>999?Math.sign(e)*(Math.abs(e)/1e3).toFixed(1)+"k":Math.sign(e)*Math.abs(e),dynamicColors=()=>"rgba("+Math.floor(200*Math.random())+","+Math.floor(200*Math.random())+","+Math.floor(200*Math.random())+", 0.7)",poolColors=e=>{var t=[];for(i=0;i<e;i++)t.push(dynamicColors());return t};function isInt(e){return!isNaN(e)&&parseInt(Number(e))==e&&!isNaN(parseInt(e,10))}function generateTableHead(e,t,a){e.createCaption().innerHTML="<div class='wb-inv'>"+a+"</div";let n=e.createTHead().insertRow();for(let e of t){let t=document.createElement("th"),a=document.createTextNode(e);t.appendChild(a),n.appendChild(t)}}function generateTable(e,t){for(let n of t){let t=e.insertRow();for(a in n){var a=n[a];let e=t.insertCell();isInt(a)&&(a=a.toLocaleString(document.documentElement.lang+"-CA"));let r=document.createTextNode(a);e.appendChild(r)}}}const jsonPieGenerate=e=>{$("#chart").remove(),$("#chart-canvas").append("<canvas id='chart'></canvas>"),val=e,cnt=val.length;var t=[{data:val,backgroundColor:poolColors(cnt)}],a={plugins:{beforeInit:(e,t)=>{Chart.Legend.afterFit=function(){this.height=this.height+50}},datalabels:{formatter:(e,t)=>{let a=0;t.chart.data.datasets[0].data.map(e=>{a+=e});let n=parseFloat((100*e/a).toFixed(1)).toLocaleString(document.documentElement.lang+"-CA");if("fr"==document.documentElement.lang)var r=" %";else r="%";return n+r},backgroundColor:function(e){return e.dataset.backgroundColor},borderRadius:4,color:"white",font:{weight:"bold"}}},tooltips:{enabled:!1},legend:{position:"bottom",minSize:{height:500}},layout:{padding:{top:25}}},n=document.getElementById("chart").getContext("2d"),r=new Chart(n,{type:"pie",data:{datasets:t,labels:[$.i18n("Desktop"),$.i18n("MobilePhone"),$.i18n("Tablet"),$.i18n("Other")]},options:a});sum=val.reduce(function(e,t){return e+t},0);let l=[];$.each(val,function(e,t){if(val=t,lab=r.data.labels[e],per=parseFloat((100*val/sum).toFixed(2)).toLocaleString(document.documentElement.lang+"-CA"),"fr"==document.documentElement.lang)var a=" %";else a="%";per+=a,val=t.toLocaleString(document.documentElement.lang+"-CA");var n={};n[$.i18n("DeviceType")]=lab,n[$.i18n("Visits")]=val,n[$.i18n("Percent")]=per,l.push(n)});let s=document.querySelector("table#tbl-pltfrm"),o=Object.keys(l[0]);s.innerHTML="",generateTable(s,l),generateTableHead(s,o,$.i18n("Number of visits by devices used")),$("#chart-pltfrms").show(),$("#chrtp").hide()},RANGE=(e,t)=>Array.from(function*(e,t){for(;e<=t;)yield e++}(e,t)),jsonTrendGenerate=(e,t)=>{var a=e.rows[0];if(null!=a){$("#trends").remove(),$("#trends-canvas").append("<canvas id='trends'></canvas>"),arr=a.data,$cnt=arr.length,val=arr.slice(0,$cnt/2),lval=arr.slice($cnt/2,$cnt),$rng=RANGE(1,$cnt/2);const e=t.replace(/^\w/,e=>e.toUpperCase());var n={plugins:{datalabels:{display:!1}},scales:{yAxes:[{scaleLabel:{display:!0,labelString:$.i18n("Numberofvisits")}}],xAxes:[{scaleLabel:{display:!0,labelString:$.i18n(e)+$.i18n("Dayofselecteddaterange")}}]},tooltips:{mode:"index",intersect:!1},hover:{mode:"nearest",intersect:!0},legend:{position:"bottom",labels:{usePointStyle:!0}},layout:{padding:{top:25}}},r=document.getElementById("trends").getContext("2d"),l=new Chart(r,{type:"line",data:{labels:$rng,datasets:[{label:$.i18n("CurrentYear"),data:val,backgroundColor:dynamicColors()},{label:$.i18n("PreviousYear"),data:lval,backgroundColor:dynamicColors()}]},options:n});let o=[];var s=1;$.each(val,function(t,a){vals=val[t],lvals=lval[t],lab=l.data.labels[t],gran=$.i18n(e)+" "+s,s++,diff=((vals-lvals)/lvals*100).toFixed(1),"Infinity"==diff?diff=$.i18n("NotAvailable"):"fr"==document.documentElement.lang?diff=parseFloat(diff).toLocaleString(document.documentElement.lang+"-CA")+" %":diff=parseFloat(diff)+"%",vals=val[t].toLocaleString(document.documentElement.lang+"-CA"),lvals=lval[t].toLocaleString(document.documentElement.lang+"-CA");var n={};n[$.i18n(e)]=gran,n[$.i18n("CurrentYear")]=vals,n[$.i18n("PreviousYear")]=lvals,n[$.i18n("Difference")]=diff,o.push(n)});let i=document.querySelector("table#tbl-trnds"),c=Object.keys(o[0]);i.innerHTML="",generateTable(i,o),generateTableHead(i,c,$.i18n("Visitstrendbycurrentyearandpreviousyear")),$("#chart-trnds").show(),$("#chrtt").hide()}else $("#chart-trnds").hide(),$("#chrtt").show()},jsonUv=e=>{var t=e.rows[0],a=$("#uv"),n=$("#rap"),r=parseInt($("#numDays").html()),l=parseInt($("#numWeeks").html());if(a.html(""),n.html(""),null!=t)return uv=t.data[0],uvDays=parseInt(uv/r).toLocaleString(document.documentElement.lang+"-CA"),uv=parseInt(uv).toLocaleString(document.documentElement.lang+"-CA"),a.prepend("<span class='h1'>"+uvDays+"</span> <strong>"+$.i18n("averageperday")+"</strong></br><span class='small'>"+uv+" "+$.i18n("total")+"</span>"),rap=t.data[1],rapWeeks=parseInt(rap/l).toLocaleString(document.documentElement.lang+"-CA"),rap=parseInt(rap).toLocaleString(document.documentElement.lang+"-CA"),n.prepend("<span class='h1'>"+rapWeeks+"</span> <strong>"+$.i18n("averageperweek")+"</strong></br><span class='small'>"+rap+" "+$.i18n("total")+"</span>"),itemid=t.itemId,itemid;a.html("0"),n.html("0")},jsonFile=e=>{},getPageTitle=e=>Object.keys(e).map((t,a)=>{var n=e[t].value;if(-1!==(n=-1!==n.indexOf("https://")?n:"https://"+n).indexOf("canada.ca")){let e=new Request(n,{method:"GET"});return fetch(e).then(e=>e.text()).then(e=>$(e).find("h1:first").text()).catch(console.error.bind(console))}}),getPageH1=e=>{if(-1!==(e=-1!==e.indexOf("https://")?e:"https://"+e).indexOf("canada.ca")){let t=new Request(e,{method:"GET"});return fetch(t).then(e=>e.text()).then(e=>$(e).find("h1:first").text()).catch(console.error.bind(console))}},getPage=e=>{if(-1!==(e=-1!==e.indexOf("https://")?e:"https://"+e).indexOf("canada.ca")){let t=new Request(e,{method:"GET"});return fetch(t).then(e=>e.text()).then(e=>({html:e})).catch(console.error.bind(console))}},jsonPrevious=e=>{var t=e.rows[0],a=$("#pp");null!=t?(arrayP=e.rows,a.html(""),a.append($("<ul>")),a=$("#pp ul"),Promise.all(getPageTitle(arrayP)).then(e=>{$.each(arrayP,function(t,n){url=n.value,term=null==e[t]?url:e[t],val=n.data[0],f="blank page url"==url?$.i18n("Directtraffic/Bookmark"):"<a href='"+url+"'>"+term+"</a>",a.append($("<li>").append(f))})}).catch(console.error.bind(console))):a.html($.i18n("Nodata"))},jsonForward=e=>{},jsonSnum=(e,t)=>{var a=e.rows[0],n=$("#snum"),r=parseInt($("#numDays").html());if(n.html(""),null!=a)return snum=a.data[t],snumDays=parseInt(snum/r).toLocaleString(document.documentElement.lang+"-CA"),snum=parseInt(snum).toLocaleString(document.documentElement.lang+"-CA"),n.prepend("<span class='h1'>"+snumDays+"</span> <strong>"+$.i18n("averageperday")+"</strong></br><span class='small'>"+snum+" "+$.i18n("total")+"</span>"),itemid=a.itemId,itemid;n.html("No data")},jsonSearches=(e,t)=>{if(null!=e.rows[0]){var a=e.rows,n=[];$.each(a,function(e,a){search=a.value,searchurl="https://www.canada.ca/en/revenue-agency/search.html?cdn=canada&st=s&num=10&langs=en&st1rt=1&s5bm3ts21rch=x&q="+search+"&_charset_=UTF-8&wb-srch-sub=",searchv=a.data[t],"0"!=searchv&&n.push({Term:search,url:searchurl,Clicks:searchv})}),0!=n.length&&(n.sort((e,t)=>t.Clicks-e.Clicks),$.each(n,function(e,t){$search="#search"+e,$searchhtml=$($search),$searchhtml.html(""),$($search).append("<a href='"+t.url+"'>"+t.Term+"</a>").append(" ("+t.Clicks.toLocaleString(document.documentElement.lang+"-CA")+")")}))}else a=new Array(4),$search=$("#search0"),$search.html($.i18n("Nodata")),$.each(a,function(e,t){0!=e&&($search=$("#search"+e),$search.html(""))})},jsonDownload=e=>{var t=e.rows[0];if($dwnld=$("#dwnld"),null!=t){var a=e.rows;$dwnld.html(""),$dwnld.append($("<ul class='colcount-sm-2'>")),$dwnld=$("#dwnld ul");var n=[],r=[];$.each(a,function(e,t){var a=t.value,l=t.data[0];a.includes(".pdf")?(a.includes("-lp")&&(type="Large Print"),a.includes("-fill-")?type="Fillable":type="Flat"):a.includes(".txt")?type="E-Text":type=a.split("/").pop().split(".").pop().toUpperCase();var s=a.split("/").pop();n.push(a),r.push({term:a,clicks:l,type:type,filename:s})}),$url="https://www.canada.ca/en/revenue-agency/services/forms-publications/td1-personal-tax-credits-returns/td1-forms-pay-received-on-january-1-later/td1.html";var l=$url.split("/").pop().split(".").shift(),s=n.findReg("^https://www.canada.ca/.*?"+l+"-(fill-)*([0-9]{1,2})"),o=$("#np");o.html(""),o.append($("<ul class='colcount-sm-2>")),o=$("#np ul"),$.each(r,function(e,t){$.each(s,function(e,a){t.term==a&&o.append($("<li>").append(t.filename+" ("+t.clicks.toLocaleString(document.documentElement.lang+"-CA")+") [<em>"+t.type+"</em>]"))})})}else $dwnld.html($.i18n("Nodata"))},jsonOutbound=(e,t)=>{var a=e.rows[0];if($outbnd=$("#outbnd"),null!=a){var n=e.rows;$outbnd.html(""),$outbnd.append($("<ul class='colcount-sm-2'>")),$outbnd=$("#outbnd ul"),Promise.all([getPage(t)]).then(e=>{e[0].html,$.each(n,function(e,t){text=t.value,outbnd=t.data[0],$outbnd.append($("<li>").append(text+" ("+outbnd.toLocaleString(document.documentElement.lang+"-CA")+")"))})})}else $outbnd.html($.i18n("Nodata"))},jsonRT=(e,t)=>{var a=e.rows[0];val="#reft",title="Referring types";var n=$(val);if(null!=a){var r=e.rows;n.html("");var l=[];if($.each(r,function(e,a){term=a.value,clicks=a.data[t];var n={};n[$.i18n("Type")]=$.i18n(term.replace(/\s/g,"")),n[$.i18n("Visits")]=clicks,l.push(n)}),0!=l.length){l.sort((e,t)=>t.Visits-e.Visits);let e=document.querySelector("table#reft"),t=Object.keys(l[0]);generateTable(e,l),generateTableHead(e,t,title),$(val).trigger("wb-init.wb-tables")}else n.html($.i18n("Nodata"))}else n.html($.i18n("Nodata"))},jsonSearch=(e,t,a,n)=>{var r=e.rows[0],l=$(t);if(null!=r){var s=e.rows;l.html("");var o=[];if($.each(s,function(e,t){if(term=t.value,clicks=t.data[n],"(Low Traffic)"!=term&&"Unspecified"!=term&&0!=clicks){var a={};a[$.i18n("Term")]=term,a[$.i18n("Clicks")]=clicks,o.push(a)}}),0!=o.length){o.sort((e,t)=>t.Clicks-e.Clicks);let e=document.querySelector("table"+t),n=Object.keys(o[0]);generateTable(e,o),generateTableHead(e,n,a)}else l.html($.i18n("Nodata"))}else l.html($.i18n("Nodata"))},jsonSearchesAll=(e,t)=>{var a=$.i18n("Searches to page");jsonSearch(e,"#srchA",a,t),$("#srchA").trigger("wb-init.wb-tables")},jsonSearchesInstitution=e=>{var t=$.i18n("Contextualsearchestopage");jsonSearch(e,"#srchI",t),$("#srchI").trigger("wb-init.wb-tables")},jsonSearchesGlobal=e=>{var t=$.i18n("Globalsearchestopage");jsonSearch(e,"#srchG",t),$("#srchG").trigger("wb-init.wb-tables")};function sortByCol(e){return e.sort((e,t)=>t.Clicks-e.Clicks)}const jsonAM=(e,t)=>{var a=e.rows[0],n=$("#np");if(null!=a){var r=e.rows;n.html("");var l=[];if($.each(r,function(e,a){if(term=a.value,val=a.data[t],"(Low Traffic)"!=term&&"Unspecified"!=term&&"0"!=val){var n={};n[$.i18n("LinkText")]=term,n[$.i18n("Clicks")]=val,l.push(n)}}),0!=l.length){l.sort((e,t)=>t.Clicks-e.Clicks);let e=document.querySelector("table#np"),t=Object.keys(l[0]);generateTable(e,l),generateTableHead(e,t,$.i18n("OutboundClicksonPage"))}else n.html($.i18n("Nodata"))}else n.html($.i18n("Nodata"))},jsonMetrics=(e,t)=>{var a=e.summaryData.filteredTotals,n=$("#uv"),r=$("#rap"),l=parseInt($("#numDays").html()),s=parseFloat($("#numWeeks").html()),o=9+parseInt(t),i=36+parseInt(t),c=12+parseInt(t),d=15+parseInt(t),u=18+parseInt(t),m=21+parseInt(t);if(n.html(""),r.html(""),null!=a){uv=parseInt(a[o]),uvDays=parseInt(uv/l).toLocaleString(document.documentElement.lang+"-CA"),uv=parseInt(uv).toLocaleString(document.documentElement.lang+"-CA"),n.prepend("<span class='h1'>"+uvDays+"</span> <strong>"+$.i18n("averageperday")+"</strong></br><span class='small'>"+uv+" "+$.i18n("total")+"</span>"),rap=parseInt(a[i]),2==t&&(s=1),rapWeeks=parseInt(rap/s).toLocaleString(document.documentElement.lang+"-CA"),rap=parseInt(rap).toLocaleString(document.documentElement.lang+"-CA"),r.prepend("<span class='h1'>"+rapWeeks+"</span> <strong>"+$.i18n("averageperweek")+"</strong></br><span class='small'>"+rap+" "+$.i18n("total")+"</span>"),desktop=parseInt(a[c]),mobile=parseInt(a[d]),tablet=parseInt(a[u]),other=parseInt(a[m]);var h=[desktop,mobile,tablet,other];jsonPieGenerate(h)}else n.html("0"),r.html("0")};function fetchWithTimeout(e,t,a,n){const r=new Promise(e=>{setTimeout(e,a,{timeout:!0})});return Promise.race([fetch(e,t),r]).then(e=>(e.timeout&&n(),e))}const apiCall=(e,t,a,n,r)=>a.map(a=>{url="fle"==a?"php/file.php":"php/process.php",post={dates:e,url:t,type:a,oUrl:n};let l=new Request(url,{method:"POST",body:JSON.stringify(post)});return fetch(l).then(e=>e.json()).then(e=>{switch(a){case"fle":return;case"snmAll":return jsonSnum(e,r);case"srchLeftAll":return jsonSearches(e,r);case"trnd":return jsonTrendGenerate(e,"day");case"prvs":return jsonPrevious(e);case"frwrd":return;case"srchAll":return jsonSearchesAll(e,r);case"activityMap":return jsonAM(e,r);case"metrics":return jsonMetrics(e,r);case"refType":return jsonRT(e,r)}}).catch(function(e){console.log(a),console.log(e.message),console.log(e.stack)})}),apiCall2=(e,t,a,n,r)=>a.map(a=>{url="php/process-new.php",post={dates:e,url:t,oUrl:n,lang:r};let l=new Request(url,{method:"POST",body:JSON.stringify(post)});return fetch(l).then(e=>e.json()).then(e=>($("#urlStatic").html("https://"+e.url),e.url)).catch(function(e){console.log(a),console.log(e.message),console.log(e.stack)})});$("#urlform").submit(function(e){e.preventDefault(),url=$("#urlval").val(),$("#urlStatic").html(url),start=$(".dr-date-start").html(),end=moment(),mainQueue(url,start,end,0)}),$("a#h2href").click(function(){event.preventDefault(),url=$("#urlStatic").html(),start=$(".dr-date-start").html(),end=moment(),mainQueue(url,start,end,1)});const removeQueryString=e=>{var t=document.createElement("a");return t.href=e,t.search="",$href=t.href,/Edge/.test(navigator.userAgent)&&($href=$href.substring(0,$href.length-1)),$href},mainQueue=(e,t,a,n)=>{if(e=removeQueryString(e),$("#canvas-container").addClass("hidden"),$("#notfound").addClass("hidden"),$("#loading").removeClass("hidden"),$success=0,console.log(e),"www."==(e="https://"==e.substring(0,8)?e.substring(8,e.length):e).substring(0,4)&&".html"==e.substring(e.length-5,e.length)){if(oUrl="https://"+e,e=e.length>255?e.substring(e.length-255,e.length):e,moment.locale("en"),$dd=$("input[name=dd-value").val(),$dd||($dd=1),t&&a)vStart=t,r=a;else{t=moment();var r=moment().format("dddd MMMM DD, YYYY");0==$dd?vStart=moment(t).subtract(30,"days").format("dddd MMMM DD, YYYY"):1==$dd?vStart=moment(t).subtract(7,"days").format("dddd MMMM DD, YYYY"):2==$dd&&(vStart=moment(t).subtract(1,"days").format("dddd MMMM DD, YYYY"))}var l=[t=moment(vStart).format("YYYY-MM-DDTHH:mm:ss.SSS"),a=moment(r).format("YYYY-MM-DDTHH:mm:ss.SSS")],s=moment(vStart),o=moment(r);s.locale(document.documentElement.lang),o.locale(document.documentElement.lang);var i=s.format("dddd MMMM DD, YYYY"),c=o.subtract(1,"days").format("dddd MMMM DD, YYYY");$("#fromdaterange").html("<strong>"+i+"</strong>"),$("#todaterange").html("<strong>"+c+"</strong>"),t=moment(vStart),a=moment(r),dDay=a.diff(t,"days"),dWeek=a.diff(t,"week",!0),$("#numDays").html(dDay),$("#numWeeks").html(dWeek),$("#searchBttn").prop("disabled",!0);var d=["dbGet"],u=["trnd","fle","prvs","srchAll","snmAll","srchLeftAll","activityMap","refType","metrics"];const m=()=>(e=$("#urlStatic").html(),oUrl=$("#urlStatic").html(),Promise.all(apiCall(l,e,u,oUrl,$dd))),h=e=>Promise.all([getPageH1(e)]);(()=>Promise.all(apiCall2(l,e,d,oUrl,n)))().then(e=>h(e)).then(e=>{$("#h2title").html(e)}).then(()=>m()).then(()=>{$("#loading").addClass("hidden"),$("#notfound").addClass("hidden"),$("#canvas-container").removeClass("hidden"),$("#searchBttn").prop("disabled",!1)}).catch(console.error.bind(console)),$success=1}$success||($("#loading").addClass("hidden"),$("#notfound").removeClass("hidden"))};